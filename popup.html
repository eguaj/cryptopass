<!DOCTYPE html> 
 
<html lang="en"> 
<head> 
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
	<title>CryptoPass</title> 
	<meta name="author" content="Dmitry Chestnykh"> 
<script type="text/javascript">

/*
 * Crypto-JS v2.0.0
 * http://code.google.com/p/crypto-js/
 * Copyright (c) 2009, Jeff Mott. All rights reserved.
 * http://code.google.com/p/crypto-js/wiki/License
 */

var cryptoWorker = new Worker('cryptoWorker.js');

// **** Password generation ****

function makePassword() {
	var secret = document.getElementById('secret').value;
	var username = document.getElementById('username').value;
	var url = document.getElementById('url').value;
	var length = document.getElementById('length').value;
    var salt = username + '@' + url;
 
	if (secret.length < 16)
		showDiv('warning');
	else
		hideDiv('warning');

	cryptoWorker.onmessage = function(event) {
		return makePassword_callback(event);
	}

	cryptoWorker.onerror = function(event) {
		makePassword_callback({'data':{'password':'Error'}});
	}

	cryptoWorker.postMessage({'secret':secret, 'salt':salt, 'length':length});

	return false;
}

function makePassword_callback(event) {
    var result_field = document.getElementById('result');
	result_field.value = event.data.password;
    showDiv('result-box');
    result_field.select();
}
 
function generatePassword()
{
    var result_field = document.getElementById('result');
	result_field.value = makePassword();
    showDiv('result-box');
    result_field.select();
	return false; // don't reload page
}

function toggleDiv(id)
{
	var infoStyle = document.getElementById(id).style;
	if (infoStyle.display == "block")
		infoStyle.display = "none";
	else
		infoStyle.display = "block";
}
 
function showDiv(id)
{
	var infoStyle = document.getElementById(id).style;
	infoStyle.display = "block";
}
 
function hideDiv(id)
{
	var infoStyle = document.getElementById(id).style;
	infoStyle.display = "none";
}

function getHostname(str) {
	var re = new RegExp('^(?:f|ht)tp(?:s)?\://(?:www.)?([^/]+)', 'im');
	return str.match(re)[1].toString();
}

function fillPassword() {
    var username = document.getElementById('username').value || "";
    chrome.tabs.executeScript(null,
        {code:"var els = document.getElementsByTagName('input'); \
               for (var i=0; i < els.length; i++) { \
                 if (els[i].type.toLowerCase() == 'password') { \
                     els[i].value = '" + makePassword() + "'; \
                 } else { \
                     var name = els[i].name.toLowerCase(); \
                     if (name.match(/login|username|email/)) { \
                       els[i].value = '" + username + "'; \
                     } \
                 } \
               }"});
  window.close();
}

</script>

<style type="text/css"> 
body {
    font: 10pt Helvetica, Arial, sans-serif;
    width: 350px;
}
.label {
    text-align: right;
    padding-right: 5px;
}
#secret, #url, #username, #result {
    width: 100%;
}
.length, #length {
    font-size: 8pt;
    color: #666;
}
.centered {
    text-align: center;
}
td.input {
    width: 265px
}
#result-box {
    display: none
}
#warning {
    display: none;
    font-size: 10px;
    color: red
}
button {
    background: #f4f4f4 -webkit-gradient(linear,left top,left bottom,
                        color-stop(0, #fafafa),color-stop(1, #ccc));
    border: 1px solid #aaa;
    border-radius: 5px;
    padding: 3px 10px;
    margin-top: 3px;
    text-shadow: 0 1px #f4f4f4;
}
button:active {
    background: #f4f4f4 -webkit-gradient(linear,left top,left bottom,
                        color-stop(1, #ddd),color-stop(0, #bbb))
}
</style> 
</head> 
<body> 
	<form onsubmit="return fillPassword()"> 
	<table> 
	<tr> 
		<td class="label">Secret</td> 
		<td class="input"><input type="password" id="secret" value=""></td> 
	</tr>
    <tr> 
		<td class="label">Username</td> 
		<td class="input"><input type="text" spellcheck="false"  id="username" value=""></td> 
	</tr>
    <tr>
		<td class="label">URL</td> 
		<td class="input"><input type="text" spellcheck="false"  id="url" value=""></td> 
	</tr>
    <tr class="length"> 
		<td class="label">Max Length</td> 
		<td class="input"><input type="text" id="length" value="25" size="2"> characters 

		<div style="float: right; margin-right: -5px">
			<button onclick="return makePassword()"><b>Show</b></button>
      <button onclick="fillPassword()">&nbsp; Fill &nbsp;</button>
		</div>
	</td></tr> 
	</table> 
	</form> 

    <div id="result-box">
        <p class="centered">Your password <span style="color:#666">(copy and paste it)</span>:
        <br> 
        <input type="text" spellcheck="false" class="centered" id="result" value=""></p> 
        
        <div id="warning"> 
            <p><b>Warning:</b> Your secret should contain at least 16 chars
            for better security.</p>
        </div> 
	</div> 
	
<script>
(function () {
    chrome.tabs.getSelected(null, function(tab) {
        document.getElementById('url').value = getHostname(tab.url);
    });
    document.getElementById('secret').focus();
})();
</script>
	
</body> 
</html>
